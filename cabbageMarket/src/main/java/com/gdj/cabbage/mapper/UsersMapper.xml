<?xml version="1.0" encoding="UTF-8"?>
<!-- 작성자 이재범 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gdj.cabbage.mapper.UsersMapper">
	<!-- 로그인 쿼리 -->
	<select id="loginSession" resultType="java.util.Map" parameterType="com.gdj.cabbage.vo.Users">
		SELECT
			user_id userId,
			email,
			nickname
		FROM
			users
		<where>
			email=#{email} AND password=PASSWORD(#{password}) AND user_state=1
		</where>			
	</select>
	
	<!-- 회원가입 쿼리 -->
	<insert id="registerUser" parameterType="com.gdj.cabbage.vo.Users">
		<selectKey keyProperty="userId" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
		INSERT 
			users(
				username, 
				email, 
				password, 
				nickname, 
				mobile, 
				modify_date, 
				user_state, 
				create_date
				) 
		VALUES(
			#{username}, 
			#{email},
			PASSWORD(#{password}),
			#{nickname},
			#{mobile, jdbcType=VARCHAR},
			NOW(),
			1,
			NOW()
			) 
	</insert>
	
	<!-- email 중복 여부  -->
	<select id="selectEmail" resultType="Integer" parameterType="com.gdj.cabbage.vo.Users">
		SELECT
			COUNT(*)
		FROM
			users
		<where>
			email=#{email}
		</where>
	</select>
	
	<!-- nickname 중복여부 -->
	<select id="selectNickname" resultType="Integer" parameterType="com.gdj.cabbage.vo.Users">
		SELECT
			COUNT(*)
		FROM
			users
		<where>
			nickname=#{nickname}
		</where>
	</select>
	
	<!-- 네이버 아이디 존재 여부 -->
	<select id="selectSnsId" resultType="Integer" parameterType="com.gdj.cabbage.vo.SNSInfo">
		SELECT
			COUNT(*)
		FROM
			sns_info
		<where>
			sns_id=#{id}
		</where>
	</select>
	
	<!--  네이버 정보 sns테이블에 등록 -->
	<insert id="registerNaverUser" parameterType="com.gdj.cabbage.vo.Users">
		INSERT 
			sns_info(
				user_id, 
				sns_id, 
				sns_type, 
				sns_name, 
				sns_profile, 
				sns_connect_Date
				) 
		VALUES(
			#{userId}, 
			#{snsId},
			#{snsType},
			#{snsName},
			#{snsProfile},
			NOW()
			) 
	</insert> 
	
	<!-- 네이버 유저 session -->
	<select id="naverLoginSession" resultType="java.util.Map" parameterType="String">
		SELECT
			u.user_id userId,
			u.email,
			u.nickname
		FROM
			users u LEFT JOIN sns_info s ON u.user_id=s.user_id 
		<where>
			s.sns_id=#{snsId}
		</where>
			
	</select>
</mapper>