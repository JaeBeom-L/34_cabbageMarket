<?xml version="1.0" encoding="UTF-8"?>
<!-- 작성자 : 강혜란 210708-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gdj.cabbage.mapper.AuctionMapper">
	
	<select id="selectAuctionList" parameterType="map" resultType="map"> <!-- 전체 aution 정보 가져오는 매퍼 *검색어 페이징추가 해야함* -->
		SELECT
			apr.apply_product_sales_delivery_id applyId
			,registration_deadline registrationDeadline
			,FORMAT(quote, N'#,0') quote
			,apr.create_date createDate
			,product_name productName
			,img_name imgName
			,category_sub_id categorySubName
			,IF(bap.apply_product_sales_delivery_id IS NULL , FORMAT(apr.min_bid_price, N'#,0') , FORMAT(bap.bid_price, N'#,0')) price
		FROM 
			auction_product_registration apr
				LEFT JOIN apply_product_sales_delivery apsd ON apr.apply_product_sales_delivery_id= apsd.apply_product_sales_delivery_id
				LEFT JOIN apply_product_sales_delivery_img apsdi ON apsd.apply_product_sales_delivery_id= apsdi.apply_product_sales_delivery_id
				LEFT JOIN bidding_auction_product bap ON apr.apply_product_sales_delivery_id= bap.apply_product_sales_delivery_id
		GROUP BY apsdi.apply_product_sales_delivery_id
		ORDER BY bap.create_date, apsd.create_date, apsdi.img_name
	</select>
	
	<select id="selectAuctionForCount" resultType="int"> <!-- 전체 aution 가져오는 매퍼 *검색어 페이징추가 해야함* -->
		SELECT
			count(*)
		FROM 
			auction_product_registration
	</select>
	
	<select id="selectAuctionOne" parameterType="int" resultType="map"> <!-- applyId로 상세정보 가져오는 매퍼 -->
		SELECT 
			apr.apply_product_sales_delivery_id applyId
			,username userName
			,category_sub_name categorySubName
			,product_name productName
			,IF(bap.apply_product_sales_delivery_id IS NULL , FORMAT(apr.min_bid_price, N'#,0') , FORMAT(bap.bid_price, N'#,0')) price
			,product_desc productDesc
			,FORMAT(quote, N'#,0') quote
			,registration_state registrationState
			,pcr.create_date createDate
			,manager_name managerName
		FROM auction_product_registration apr
				LEFT JOIN product_confirmation_registration pcr ON apr.apply_product_sales_delivery_id= pcr.apply_product_sales_delivery_id
				LEFT JOIN apply_product_sales_delivery apsd ON apr.apply_product_sales_delivery_id= apsd.apply_product_sales_delivery_id
				LEFT JOIN bidding_auction_product bap ON apr.apply_product_sales_delivery_id= bap.apply_product_sales_delivery_id
				LEFT JOIN manager ON pcr.manager_id = manager.manager_id
				LEFT JOIN users ON apsd.user_id = users.user_id
				LEFT JOIN category_sub sub ON apsd.category_sub_id=sub.category_sub_id
		WHERE apr.apply_product_sales_delivery_id = #{applyId}
		GROUP BY apr.apply_product_sales_delivery_id
	</select>
	
	<select id="selectApplyForCount" parameterType="map" resultType="int"> <!-- 전체 apply 가져오는 매퍼 *검색어 페이징추가 해야함* -->
		SELECT
			count(*)
		FROM 
			apply_product_sales_delivery
		WHERE
			user_id = #{userId}
	</select>
	
	<select id="selectApplyList" parameterType="map" resultType="map"> <!-- 전체 aution 정보 가져오는 매퍼 *검색어 페이징추가 해야함* -->
		SELECT
			apsd.apply_product_sales_delivery_id applyId
			,apr.create_date createDate
			,CASE WHEN pcr.registration_state = '0' THEN '판매완료'
					WHEN pcr.registration_state = '1' THEN '중고등록완료'
					WHEN pcr.registration_state = '2' THEN '경매등록완료'
					WHEN pcr.registration_state = '9' THEN '미등록'
					WHEN pcr.registration_state IS NULL THEN '배송확인전'
			END AS registrationState
			,CASE WHEN pcr.registration_state = '0' THEN null
					WHEN pcr.registration_state = '1' THEN FORMAT(upr.product_price, N'#,0')
					WHEN pcr.registration_state = '2' THEN IF(bap.apply_product_sales_delivery_id IS NULL , FORMAT(apr.min_bid_price, N'#,0') , FORMAT(bap.bid_price, N'#,0')) 
					WHEN pcr.registration_state = '9' THEN null
					WHEN pcr.registration_state IS NULL THEN null
			END price			
			,CASE WHEN pcr.registration_state = '0' THEN null
					WHEN pcr.registration_state = '1' THEN upr.registration_deadline
					WHEN pcr.registration_state = '2' THEN apr.registration_deadline
					WHEN pcr.registration_state = '9' THEN null
					WHEN pcr.registration_state IS NULL THEN null
			END registrationDeadline
			
			,product_name productName
			,img_name imgName
			
		FROM 
			apply_product_sales_delivery apsd
				LEFT JOIN apply_product_sales_delivery_img apsdi ON apsd.apply_product_sales_delivery_id= apsdi.apply_product_sales_delivery_id
				LEFT JOIN product_confirmation_registration pcr ON apsd.apply_product_sales_delivery_id= pcr.apply_product_sales_delivery_id
				LEFT JOIN auction_product_registration apr ON apsd.apply_product_sales_delivery_id= apr.apply_product_sales_delivery_id
				LEFT JOIN bidding_auction_product bap ON apsd.apply_product_sales_delivery_id = bap.apply_product_sales_delivery_id
				LEFT JOIN used_product_registration upr ON apsd.apply_product_sales_delivery_id= upr.apply_product_sales_delivery_id
		WHERE
			apsd.user_id = #{userId}
		GROUP BY apsd.apply_product_sales_delivery_id
		ORDER BY pcr.create_date, apsd.create_date, apsdi.img_name
	</select>
	
	<select id="selectApplynOne" parameterType="int" resultType="map"> <!-- applyId로 상세정보 가져오는 매퍼 -->
		SELECT 
			apsd.apply_product_sales_delivery_id applyId
			,apsd.create_date dreateDate
			,username userName
			,category_sub_name categorySubName
			,product_name productName
			
		FROM apply_product_sales_delivery apsd
			LEFT JOIN product_confirmation_registration pcr ON apsd.apply_product_sales_delivery_id = pcr.apply_product_sales_delivery_id
			LEFT JOIN users ON apsd.user_id = users.user_id
			LEFT JOIN category_sub sub ON apsd.category_sub_id = sub.category_sub_id
		WHERE apsd.apply_product_sales_delivery_id = #{applyId}
	</select>
	
	<insert id="insertAuction" parameterType="com.gdj.cabbage.vo.AuctionProductRegistration">
	INSERT INTO auction_product_registration (
		apply_product_sales_delivery_id
		,product_desc
		,min_bid_price
		,quote
		,registration_deadline
		,create_date
		)
		VALUES(
		#{applyProductSalesDeliveryId}
		,#{productDesc}
		,#{minBidPrice}
		,#{quote}
		,#{registrationDeadline}
		,NOW()
		)
	</insert>
	
	<update id="updateConfirmationState" parameterType="int">
	UPDATE product_confirmation_registration
	SET registration_state = 2
	WHERE apply_product_sales_delivery_id = ${applyId};
	</update>
	
</mapper>